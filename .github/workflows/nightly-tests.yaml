name: Nightly Tests
on:
  schedule:
    - cron: "0 9 * * *" # run at 9:00 AM UTC
  workflow_dispatch: # to trigger manually

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  actions: write
  contents: read

jobs:
  format:
    uses: ./.github/workflows/format.yaml

  actionlint:
    uses: ./.github/workflows/actionlint.yaml

  test-shell:
    uses: ./.github/workflows/test-shell.yaml
    needs: format

  test-local:
    uses: ./.github/workflows/test-local.yaml
    needs: format

  test-stable:
    uses: ./.github/workflows/test-stable.yaml
    needs: format

  nightly-summary:
    runs-on: ubuntu-latest
    needs: [format, actionlint, test-shell, test-local, test-stable]
    if: always()
    steps:
      - name: Nightly Tests Summary
        run: |
          echo "## Nightly Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Format checks: ${{ needs.format.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Actionlint: ${{ needs.actionlint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Shell tests: ${{ needs.test-shell.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Local tests: ${{ needs.test-local.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Stable tests: ${{ needs.test-stable.result }}" >> $GITHUB_STEP_SUMMARY
