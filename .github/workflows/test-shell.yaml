name: Shell Unit Tests

on:
  workflow_call:
  workflow_dispatch: # to trigger manually

permissions:
  contents: read
  actions: read

jobs:
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os:
          [
            ubuntu-latest,
            ubuntu-24.04,
            ubuntu-22.04,
            ubuntu-24.04-arm,
            ubuntu-22.04-arm,
            macos-latest,
            macos-26,
            macos-15,
            macos-14,
            macos-15-intel,
          ]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache apt packages
        if: runner.os == 'Linux'
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-bats-${{ hashFiles('.github/workflows/test-shell.yaml') }}
          restore-keys: |
            ${{ runner.os }}-apt-bats-
            ${{ runner.os }}-apt-

      - name: Install bats-core on Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Cache Homebrew packages
        if: runner.os == 'macOS'
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-brew-bats-${{ hashFiles('.github/workflows/test-shell.yaml') }}
          restore-keys: |
            ${{ runner.os }}-brew-bats-
            ${{ runner.os }}-brew-

      - name: Install bats-core on macOS
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install bats-core

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running BATS unit tests on ${{ matrix.os }}..."
          bats --recursive tests
          echo "âœ… All unit tests passed on ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
